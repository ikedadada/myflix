name: Backend Deploy (dev)

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:

jobs:
  migrate-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.DEV_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      ACCESS_JWKS_URL: "https://${{ secrets.DEV_ACCESS_DOMAIN }}/cdn-cgi/access/certs"
      ACCESS_JWT_AUD: ${{ secrets.DEV_ACCESS_JWT_AUD }}
      CORS_ALLOWED_ORIGINS: ${{ secrets.DEV_CORS_ALLOWED_ORIGINS }}
      GEMINI_API_KEY: ${{ secrets.DEV_GEMINI_API_KEY }}
      GEMINI_MODEL: ${{ secrets.DEV_GEMINI_MODEL }}
      PROJECT_SLUG: myflix
      ENVIRONMENT: dev
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24.11.1
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Resolve D1 database info
        id: resolve_d1
        run: |
          DATABASE_NAME="${PROJECT_SLUG}-${ENVIRONMENT}-db"
          echo "DATABASE_NAME=${DATABASE_NAME}" >> "$GITHUB_ENV"
          DATABASE_ID=$(curl -s -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/d1/database" \
            | jq -r ".result[] | select(.name==\"${DATABASE_NAME}\") | .uuid")
          if [ -z "$DATABASE_ID" ] || [ "$DATABASE_ID" = "null" ]; then
            echo "Failed to resolve D1 database id for ${DATABASE_NAME}" >&2
            exit 1
          fi
          echo "DATABASE_ID=${DATABASE_ID}" >> "$GITHUB_ENV"

      - name: Prepare wrangler config
        run: |
          sed \
            -e "s#REPLACE_WITH_DEV_D1_ID#${DATABASE_ID}#g" \
            -e "s#REPLACE_WITH_DEV_D1_NAME#${DATABASE_NAME}#g" \
            wrangler.toml > wrangler.ci.toml

      - name: Set Gemini API key secret (dev)
        run: |
          if [ -z "${GEMINI_API_KEY}" ]; then
            echo "GEMINI_API_KEY is not set" >&2
            exit 1
          fi
          printf "%s" "${GEMINI_API_KEY}" | npx wrangler secret put GEMINI_API_KEY --env dev --config wrangler.ci.toml

      - name: Migrate D1 (dev)
        run: npx wrangler d1 migrations apply "${DATABASE_NAME}" --env dev --config wrangler.ci.toml --remote

      - name: Deploy Worker (dev)
        run: npm run deploy -- --env dev --config wrangler.ci.toml --var "ACCESS_JWKS_URL:${ACCESS_JWKS_URL}" --var "ACCESS_JWT_AUD:${ACCESS_JWT_AUD}" --var "CORS_ALLOWED_ORIGINS:${CORS_ALLOWED_ORIGINS}" --var "GEMINI_MODEL:${GEMINI_MODEL:-gemini-1.5-pro}"
