openapi: 3.0.3
info:
  title: MyFlix API
  version: 0.1.0
  description: |
    OpenAPI specification for the MyFlix backend (Hono + Cloudflare Workers).
    The base path is `/api`.
servers:
  - url: /api
security:
  - cfAccessJwt: []

tags:
  - name: auth
  - name: videos
  - name: uploads
  - name: playback
  - name: settings

paths:
  /auth/me:
    get:
      tags: [auth]
      summary: Get current user profile
      responses:
        '200':
          description: Authenticated user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/callback:
    get:
      tags: [auth]
      summary: Auth callback redirect
      parameters:
        - in: query
          name: next
          required: false
          schema:
            type: string
            default: '/'
          description: Redirect destination after auth completes
      responses:
        '302':
          description: Redirect to `next`
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /videos:
    get:
      tags: [videos]
      summary: List videos for the current user
      responses:
        '200':
          description: Video list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VideoSummary'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags: [videos]
      summary: Create a video from an upload session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateVideoRequest'
      responses:
        '201':
          description: Created video
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoSummary'
        '400':
          description: Invalid payload or create failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /videos/{id}/metadata:
    get:
      tags: [videos]
      summary: Get metadata summary for a video
      parameters:
        - $ref: '#/components/parameters/VideoId'
      responses:
        '200':
          description: Metadata summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoMetadata'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Video not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /videos/{id}/stream:
    get:
      tags: [videos]
      summary: Stream video content
      parameters:
        - $ref: '#/components/parameters/VideoId'
      responses:
        '200':
          description: Video binary stream
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Video not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /videos/{id}/thumbnail:
    get:
      tags: [videos]
      summary: Get video thumbnail image
      parameters:
        - $ref: '#/components/parameters/VideoId'
      responses:
        '200':
          description: Thumbnail image
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Thumbnail not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /videos/analyze:
    post:
      tags: [videos]
      summary: Generate video title/description from AI
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - video
                - tone
              properties:
                video:
                  type: string
                  format: binary
                tone:
                  $ref: '#/components/schemas/VideoTone'
                userContext:
                  type: string
                  maxLength: 300
                language:
                  type: string
                  description: Optional hint (currently ignored by backend)
      responses:
        '200':
          description: Generated copy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeneratedVideoCopy'
        '400':
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: AI response invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /videos/{id}/thumbnail/from-video:
    post:
      tags: [videos]
      summary: Generate thumbnail from a video (not supported)
      parameters:
        - $ref: '#/components/parameters/VideoId'
      responses:
        '501':
          description: Not implemented
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /uploads:
    get:
      tags: [uploads]
      summary: List upload sessions
      responses:
        '200':
          description: Upload sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UploadSession'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags: [uploads]
      summary: Upload a video or thumbnail payload
      parameters:
        - in: query
          name: kind
          required: false
          schema:
            $ref: '#/components/schemas/UploadKind'
          description: Upload kind (defaults to video)
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: Upload session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          description: Empty upload payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /videos/{id}/progress:
    get:
      tags: [playback]
      summary: Get playback progress
      parameters:
        - $ref: '#/components/parameters/VideoId'
      responses:
        '200':
          description: Playback progress (null when not found)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaybackProgress'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags: [playback]
      summary: Update playback progress
      parameters:
        - $ref: '#/components/parameters/VideoId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlaybackUpdate'
      responses:
        '200':
          description: Update result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /settings:
    get:
      tags: [settings]
      summary: Get user settings
      responses:
        '200':
          description: Settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settings'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags: [settings]
      summary: Update user settings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSettingsRequest'
      responses:
        '200':
          description: Updated settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settings'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    cfAccessJwt:
      type: apiKey
      in: header
      name: cf-access-jwt-assertion
      description: Cloudflare Access JWT assertion (skipped in local env)

  parameters:
    VideoId:
      in: path
      name: id
      required: true
      schema:
        type: string

  schemas:
    ErrorResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string

    OkResponse:
      type: object
      required: [ok]
      properties:
        ok:
          type: boolean

    UserProfile:
      type: object
      required: [id, email, displayName, createdAt]
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        displayName:
          type: string
        createdAt:
          type: string
          format: date-time

    VideoSummary:
      type: object
      required: [id, title, description, durationSeconds, objectKey, thumbnailUrl]
      properties:
        id:
          type: string
        title:
          type: string
        description:
          type: string
        durationSeconds:
          type: number
        objectKey:
          type: string
        thumbnailUrl:
          type: string
          nullable: true

    CreateVideoRequest:
      type: object
      required: [uploadId, title, description, durationSeconds]
      properties:
        uploadId:
          type: string
        title:
          type: string
        description:
          type: string
        durationSeconds:
          type: number
        thumbnailObjectKey:
          type: string
          nullable: true

    VideoMetadata:
      type: object
      required: [videoId, lastPositionSeconds, thumbnailUrl]
      properties:
        videoId:
          type: string
        lastPositionSeconds:
          type: number
          nullable: true
        thumbnailUrl:
          type: string
          nullable: true

    VideoTone:
      type: string
      enum: [friendly, professional, playful, concise]

    GeneratedVideoCopy:
      type: object
      required: [title, description, tone]
      properties:
        title:
          type: string
        description:
          type: string
        tone:
          $ref: '#/components/schemas/VideoTone'
        model:
          type: string
        durationMs:
          type: number

    UploadKind:
      type: string
      enum: [video, thumbnail]

    UploadSession:
      type: object
      required: [id, status, createdAt, objectKey]
      properties:
        id:
          type: string
        status:
          type: string
          enum: [pending, processing, completed, failed]
        createdAt:
          type: string
          format: date-time
        objectKey:
          type: string

    UploadResponse:
      type: object
      required: [id, status, objectKey]
      properties:
        id:
          type: string
        status:
          type: string
          enum: [pending, processing, completed, failed]
        objectKey:
          type: string

    PlaybackProgress:
      type: object
      required: [position]
      properties:
        position:
          type: number
          nullable: true

    PlaybackUpdate:
      type: object
      required: [position]
      properties:
        position:
          type: number

    Settings:
      type: object
      required: [id, ownerId, autoplay]
      properties:
        id:
          type: string
        ownerId:
          type: string
        autoplay:
          type: boolean

    UpdateSettingsRequest:
      type: object
      required: [autoplay]
      properties:
        autoplay:
          type: boolean
